# Notemania
## Математическая модель
### Основной игровой процесс 

Игра имеет два вида нот: 
 * Нота, которую достаточно просто вовремя нажать (Click).
 * Нота, которую нужно нажать и держать до её конца (Hold).

Каждой из дорожек соответствует своя собственная клавиша на клавиатуре. По стандарту это клавиши (слева направо в соответствии с дорожками):
 * **D F J K** для режима *4k*.
 * **D F <Space> J K** для *5k*.
 * **S D F J K L** для *6k*.
 * **S D F <Space> J K L** для *7k*ю
(*k* означает количество дорожек/клавиш)

Назначение клавиш можно в любой момент поменять в настройках игры.

#### Система получения очков
Количество полученных игроком очков от каждого попадания в ноту зависит от точности нажатия на эту ноту. 

Количество отклонения в милисекундах от идеального нажатия называется *Unstable Rate* (*UR*), чем выше по модулю это число, тем менее точно игрок попадает по ноте.

Максимально допустимый UR для данной карты зависит от общей сложности карты (*Overall Difficulty - OD*), - чем она выше, тем меньше допустимый UR. 

Возможность тайминговой ошибки при нажатии определяются следующим образом (сколько времени даётся для получения нужного количества очков как в левую (-ms), так и в правую (+ms) сторону):
```
320 = 16ms
300 = 64 - (3 * OD)ms
200 = 97 - (3 * OD)ms
100 = 127 - (3 * OD)ms
50 = 151 - (3 * OD)ms
Early Miss = 188 - (3 * OD)ms
Miss = формула для 50 в правую сторону + 1
```

Примеры:
 - Игрок нажал на ноту с ошибкой в 18ms от идеала в левую сторону (т.е. нажал раньше положенного), таким образом он получает 300 очков (Perfect).
 - Игрок нажал на ноту с ошибкой в 10ms от идеала в правую сторону (т.е. нажал позже положенного), таким образон он получает 320 очков (Marvelous).

Чем левее находится значение относительно середины (нуля), тем раньше нота была нажата (-ms), и чем правее - тем, соответственно, позже (+ms).

В зависимости от UR игрок может получить следующее количество очков за нажатие:

Название | Количество очков
--- | --- 
*Marvelous* | 320
*Perfect* | 300
*Great* | 200
*Good* | 100
*Bad* | 50
*Miss* | 0

Таким образом:
##### Для обычных нот
 - 320, 300, 200, 100 или 50 могут быть получены в зависимости от точности нажатия
 - *Miss* даётся при пропуске ноты (она вышла за пределы тайминга возможности нажатия на 50 справа), либо при слишком раннем её нажатии (она не вошла в пределы тайминга возможности нажатия на 50 слева)

##### Для длинных нот
 - Количество очков за такую ноту зависит как от точности нажатия на начальную точку ноты, так и точности отжатия конца ноты.
 - Игрок держит ноту до самого её конца с идеальными начальным и конечным таймингами: *Marvelous*
 - Игрок держит ноту до самого её конца без её отжатия в нужный момент: *Great*
 - Игрок совершает **NG** и не пытается нажать и удержать её снова: *Miss*
 - Игрок совершает **NG**, но снова нажимает и удерживает эту ноту: *Bad*
Где **NG** - NotGood, что означает отжатие ноты до того момента, как она закончилась.

Максимальное количество очков, которое игрок может получить на любой карте, является 1 миллион (1,000,000).

Количество очков делится на две части: *базовое количество очков* (BaseScore) и *бонусное количество очков* (BonusScore), каждая из которых затрагивает ровно половину (50%) от *общего счёта* (Score).

 - Базовое количество очков базируется на точности нажатия.
   - *Marvelous* даёт немного больше очков, чем *Perfect* (320 против 300).
 - Бонусное количество очков базируется на точности нажатия и на множителе количества бонусных очков.
   - Множитель очков увеличивается с каждым *Marvelous* или *Perfect*, но уменьшается при каждом *Great* и ниже.
   - Чем выше точность игрока, тем сильнее увеличивается множитель/меньше уменьшение.
     - Однако существует верхний предел для множителя.

Количество очков, которая даёт каждая нота, рассчитывается по формуле:
```
Score = BaseScore + BonusScore

BaseScore = (MaxScore * 0.5 / TotalNotes) * (HitValue / 320)

BonusScore = (MaxScore * 0.5 / TotalNotes) * (HitBonusValue * Sqrt(Bonus) / 320)
Bonus = Bonus before hit + HitBonus - HitPunishment
// Bonus может находиться только в пределах отрезка [1, 100], изначально он равен 100.

MaxScore = 1 000 000

// Таблица значений находится ниже 
```

Judgement | HitValue | HitBonusValue | HitBonus | HitPunishment
--- | --- | --- | --- | ---
*Marvelous* | 320 | 32 | 2 | 0
*Perfect* | 300 | 32 | 1 | 0
*Great* | 200 | 16 | 0 | 8
*Good* | 100 | 8 | 0 | 24
*Bad* | 50 | 4 | 0 | 44
*Miss* | 0 | 0 | 0 | inf

#### Система рангов
Полученный ранг зависит от конечной точности, которую имел игрок при завершении карты (*Acc* - конечная точность).

Ранг | Условие получения 
--- | ---
**SSS** | 100% *Acc*, у игрока только *Marvelous*
**SS** | 100% *Acc*, у игрока только *Marvelous* и/или *Perfect*
**S** | *Acc* > 95%
**A** | *Acc* > 90%
**B** | *Acc* > 80%
**C** | *Acc* > 70%
**D** | *Acc* <= 70%

#### Система подсчёта точности
Точность игрока рассчитывается по ходу игры и зависит от формулы
``` 
Accuracy = TotalPointsOfHits / (TotalNumberOfHits * 300) 

TotalPointsOfHits = (NumOfBads * 50 + NumOfGoods * 100 + NumOfGreats * 200 + NumOfPerfects * 300 + NumberOfMarvelouses * 300)
TotalNumberOfHits = (NumOfMisses + NumOfBads + NumOfGoods + NumOfGreats + NumOfPerfects + NumOfMarvelouses)
```

#### Система комбо
Следующие пункты приведут к увеличению значения текущего комбо:
 - Завершение ноты на нужной дорожке с нужной клавишей.
 - Удержание ноты на нужной дорожке с нужной клавишей.

Следующие пункты приведут к обнулению значения текущего комбо:
 - Нота не была завершена.
 - Отжатие ноты в то время, как она продолжала идти.

Следующий пункт никак не изменяет значение текущего комбо:
 - Отжатие удерживаемой ноты на конечной ноте удержания.