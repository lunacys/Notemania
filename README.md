# Notemania
## Математическая модель
### Основной игровой процесс 

Игра имеет два вида нот: 
 * Нота, которую достаточно просто вовремя нажать (Click).
 * Нота, которую нужно нажать и держать до её конца (Hold).

Каждой из дорожек соответствует своя собственная клавиша на клавиатуре. По стандарту это клавиши (слева направо в соответствии с дорожками):
 * **D F J K** для режима *4k*.
 * **D F "Space" J K** для *5k*.
 * **S D F J K L** для *6k*.
 * **S D F "Space" J K L** для *7k*.
(*k* означает количество дорожек/клавиш)

Назначение клавиш можно в любой момент поменять в настройках игры.

#### Система получения очков
Количество полученных игроком очков от каждого попадания в ноту зависит от точности нажатия на эту ноту. 

Количество отклонения в милисекундах от идеального нажатия называется *Unstable Rate* (*UR*), чем выше по модулю это число, тем менее точно игрок попадает по ноте.

Максимально допустимый UR для данной карты зависит от общей сложности карты (*Overall Difficulty - OD*), - чем она выше, тем меньше допустимый UR. 

Возможность тайминговой ошибки при нажатии определяются следующим образом (сколько времени даётся для получения нужного количества очков как в левую (-ms), так и в правую (+ms) сторону):
```
320 = 16ms
300 = 64 - (3 * OD)ms
200 = 97 - (3 * OD)ms
100 = 127 - (3 * OD)ms
50 = 151 - (3 * OD)ms
Early Miss = 188 - (3 * OD)ms
Miss = формула для 50 в правую сторону + 1
```

Примеры:
 - Игрок нажал на ноту с ошибкой в 18ms от идеала в левую сторону (т.е. нажал раньше положенного), таким образом он получает 300 очков (Perfect).
 - Игрок нажал на ноту с ошибкой в 10ms от идеала в правую сторону (т.е. нажал позже положенного), таким образон он получает 320 очков (Marvelous).

Чем левее находится значение относительно середины (нуля), тем раньше нота была нажата (-ms), и чем правее - тем, соответственно, позже (+ms).

В зависимости от UR игрок может получить следующее количество очков за нажатие:

Название | Количество очков
--- | --- 
*Marvelous* | 320
*Perfect* | 300
*Great* | 200
*Good* | 100
*Bad* | 50
*Miss* | 0

Таким образом:
##### Для обычных нот
 - 320, 300, 200, 100 или 50 могут быть получены в зависимости от точности нажатия
 - *Miss* даётся при пропуске ноты (она вышла за пределы тайминга возможности нажатия на 50 справа), либо при слишком раннем её нажатии (она не вошла в пределы тайминга возможности нажатия на 50 слева)

##### Для длинных нот
 - Количество очков за такую ноту зависит как от точности нажатия на начальную точку ноты, так и точности отжатия конца ноты.
 - Игрок держит ноту до самого её конца с идеальными начальным и конечным таймингами: *Marvelous*
 - Игрок держит ноту до самого её конца без её отжатия в нужный момент: *Great*
 - Игрок совершает **NG** и не пытается нажать и удержать её снова: *Miss*
 - Игрок совершает **NG**, но снова нажимает и удерживает эту ноту: *Bad*
Где **NG** - NotGood, что означает отжатие ноты до того момента, как она закончилась.

Максимальное количество очков, которое игрок может получить на любой карте, является 1 миллион (1,000,000).

Количество очков делится на две части: *базовое количество очков* (BaseScore) и *бонусное количество очков* (BonusScore), каждая из которых затрагивает ровно половину (50%) от *общего счёта* (Score).

 - Базовое количество очков базируется на точности нажатия.
   - *Marvelous* даёт немного больше очков, чем *Perfect* (320 против 300).
 - Бонусное количество очков базируется на точности нажатия и на множителе количества бонусных очков.
   - Множитель очков увеличивается с каждым *Marvelous* или *Perfect*, но уменьшается при каждом *Great* и ниже.
   - Чем выше точность игрока, тем сильнее увеличивается множитель/меньше уменьшение.
     - Однако существует верхний предел для множителя.

Количество очков, которая даёт каждая нота, рассчитывается по формуле:
```
Score = BaseScore + BonusScore

BaseScore = (MaxScore * 0.5 / TotalNotes) * (HitValue / 320)

BonusScore = (MaxScore * 0.5 / TotalNotes) * (HitBonusValue * Sqrt(Bonus) / 320)
Bonus = Bonus before hit + HitBonus - HitPunishment
// Bonus может находиться только в пределах отрезка [1, 100], изначально он равен 100.

MaxScore = 1 000 000

// Таблица значений находится ниже 
```

Judgement | HitValue | HitBonusValue | HitBonus | HitPunishment
--- | --- | --- | --- | ---
*Marvelous* | 320 | 32 | 2 | 0
*Perfect* | 300 | 32 | 1 | 0
*Great* | 200 | 16 | 0 | 8
*Good* | 100 | 8 | 0 | 24
*Bad* | 50 | 4 | 0 | 44
*Miss* | 0 | 0 | 0 | inf

#### Система рангов
Полученный ранг зависит от конечной точности, которую имел игрок при завершении карты (*Acc* - конечная точность).

Ранг | Условие получения 
--- | ---
**SSS** | 100% *Acc*, у игрока только *Marvelous*
**SS** | 100% *Acc*, у игрока только *Marvelous* и/или *Perfect*
**S** | *Acc* > 95%
**A** | *Acc* > 90%
**B** | *Acc* > 80%
**C** | *Acc* > 70%
**D** | *Acc* <= 70%

#### Система подсчёта точности
Точность игрока рассчитывается по ходу игры и зависит от формулы
``` 
Accuracy = TotalPointsOfHits / (TotalNumberOfHits * 300) 

TotalPointsOfHits = (NumOfBads * 50 + NumOfGoods * 100 + NumOfGreats * 200 + NumOfPerfects * 300 + NumberOfMarvelouses * 300)
TotalNumberOfHits = (NumOfMisses + NumOfBads + NumOfGoods + NumOfGreats + NumOfPerfects + NumOfMarvelouses)
```

#### Система комбо
Следующие пункты приведут к увеличению значения текущего комбо:
 - Завершение ноты на нужной дорожке с нужной клавишей.
 - Удержание ноты на нужной дорожке с нужной клавишей.

Следующие пункты приведут к обнулению значения текущего комбо:
 - Нота не была завершена.
 - Отжатие ноты в то время, как она продолжала идти.

Следующий пункт никак не изменяет значение текущего комбо:
 - Отжатие удерживаемой ноты на конечной ноте удержания.

### Общая информация о содержании папок
Папка | Предназначение папки | Какие файлы хранятся | Предназначение файлов
--- | --- | --- | ---
/ | | Notemania.exe, *.dll, *.db | Бинарный файл игры; необходимые для работы программы библиотеки; база данных, хранящая все карты 
/data/ | Основные ресурсы игры | |
/data/fonts/ | | *.png, *.txt, *.ttf | Используемые в игре шрифты
/data/images/ | | *.png, *.jpg, *.bmp | Используемые в игре файлы изображений
/data/music/ | | *.ogg | Музыка
/data/sfx/ | | *.wav | Звуковые эффекты
/data/shaders/ | | *.frag, *.vert | Шейдеры
/logs/ | Хранение логов | *.log | Логи содержат всю отладочную информацию
/maps/ | Хранение всех карт | | 
/maps/"mapID map name"/ | Хранение файлов карты | *.noma, *.png, *.jpg, *.ogg, *.wav | *.noma - формат, в котором хранятся все данные о карте; *.png, *.jpg - файлы, хранящие задний фон для карты; *.ogg - файл музыки; *.wav - файлы звуковых эффектов
/skins/ | Хранение всех скинов | | |
/skins/"skin name"/ | Хранение файлов конкретного скина | *.png, *.jpg, *.wav, *.ogg, Skin.txt | *.png, *.jpg - фоны, иконки, различные изображения; *.wav, *.ogg - звуковые эффекты; Skin.txt - хранение основных данных о скине

### Подробная информация о используемых собственных форматах
#### *.noma
Данный формат является простым *.ini файлом, содержащий данные о карте. Данные представляются в формате *Ключ:Значение*, при этом ключи разбиты на секции. Секции определяются квадратными скобками ( `[]` ).

Первая строка - используемая версия формата. Единственный доступный вариант - `v1`

Секция `[General]`:
Ключ | Описание | Пример
--- | --- | ---
`AudioFilename` | Используемый музыкальный файл в качестве мелодии | `Гражданская Оборона - Моя Оборона.ogg`
`PreviewTime` | Точка песни, которая будет проигрываться при выборе карты в меню игры, в миллисекундах | `76767`

Секция `[Editor]` содержит одну пару Ключ/Значение: `BeatDivisor`, обозначающий то, какое разделение битов используется в карте. Варьируется от 1 до 16.

Секция `[Metadata]`:
Ключ | Описание | Пример
--- | --- | ---
`Title` | Название песни | `Моя Оборона`
`Artist` | Автор песни | `Гражданская Оборона`
`Creator` | Создатель карты | `lunacys`
`Version` | Название сложности карты (её версии) | `Hard`
`Tags` | Тэги, по которым карту можно найти при помощи поиска внутри игры; разделяются пробелом | `there are some tags`
`BeatmapID` | Уникальный идентификатор текущей карты | `1`
`BeatmapSetID` | Уникальный идентификатор сета карт. Для всех карт из одного сета используется один и тот же идентификатор | `1`

Секция `[Difficulty]`
Ключ | Описание | Пример
--- | --- | ---
`HPDrainRate` | С какой скоростью будет уменьшаться полоска здоровья при промахе (от 1 до 10) | `9`
`OverallDifficulty` | Какая возможна максимальная ошибка при нажатии на ноту (от 1 до 10) | `9`
`KeyAmount` | Количество клавиш, используемых на данной карте (от 4 до 7) | `4`

Секция `[TimingPoints]` содержит некоторое количество тайминговых точек на карте. Каждая из точек находится на новой строке в файле. Определение точки имеет следующий формат:
```
Position,MsPerBeat,TimeSignature,HitSoundVolume,ResetMetronome

Position - позиция в миллисекундах в мелодии относительно начала (00:00:000)
MsPerBeat - количество миллисекунд, проходящих за один бит. Для перевода из BPM используется следующая формула: 60000/BPM
TimeSignature - тип используемого бита (3 для 3/4, 4 для 4/4)
HitSoundVolume - с какой громкостью будет воспроизводиться звуковой эффект при нажатии на ноту
ResetMetronome - нужно ли сбрасывать метроном при достижении данной точки (1 - да, 0 - нет)
```

Секция `[HitObjects]` содержит все ноты. Каждая из нот находится на новой строке. Нота *Click* (обычная) определяется так:
```
x,time,type

x - позиция по оси x (от 1 до KeyAmount)
time - позиция на временном промежутке в миллисекундах (определяет то, в какой момент времени данная нота должна быть нажата)
type - тип ноты: 1 для обычной, 2 для длинной
```

Определение ноты *Hold* (длинной):
```
x,time,type,endTime

x, time и type то же самое, что и у обычной ноты
endTime - время конца ноты в миллисекундах
```


#### Skin.txt

